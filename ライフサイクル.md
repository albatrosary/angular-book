# Router Guards

ルーティングには [Routing Guards](https://angular.io/docs/ts/latest/guide/router.html) という機能があり、ページ遷移するときのイベント処理やセキュリティとして問題がある場合に遷移禁止等処理が行えるようになっています。具体的には5つの Guards があります。

| Guards | 内容 |
| :--- | :--- |
| CanActivate | ルートへのナビゲーション評価 |
| CanActivateChild | 小ルートへのナビゲーション評価 |
| CanDeactivate | 現在のルートからナビゲーションを評価 |
| Resolve | アクティブ化する前のプリフェッチ評価 |
| CanLoad | 非同期ルートの評価 |

ルーティングに指定されているコンポーネント

* home.component
* pages.component
* top.component
* issue.component
* wiki.component

についてそれぞれ Guards を定義します。

```
$ ng g service home/guards-home
$ ng g service pages/guards-pages
$ ng g service pages/top/guards-top
$ ng g service pages/issue/guards-issue
$ ng g service pages/wiki/guards-wiki
```

### home.component に Routing Guards を定義

guards-home.service.ts は次のように定義しています。

```
import { Injectable } from '@angular/core';
import {
  CanActivate,
  CanActivateChild,
  CanDeactivate,
  Resolve,
  CanLoad
} from '@angular/router';

import { HomeComponent } from './home.component';

@Injectable()
export class GuardsHomeService implements CanActivate, CanActivateChild, CanDeactivate<HomeComponent>, Resolve<HomeComponent>, CanLoad {

  constructor() { }

  canActivate(): boolean {
    console.log('GuardsHomeService.canActivate()');
    return true;
  }

  canActivateChild(): boolean {
    console.log('GuardsHomeService.canActivateChild()');
    return true;
  }

  canDeactivate(): boolean {
    console.log('GuardsHomeService.canDeactivate()');
    return true;
  }

  resolve(): boolean {
    console.log('GuardsHomeService.resolve()');
    return true;
  }

  canLoad(): boolean {
    console.log('GuardsHomeService.canLoad()');
    return true;
  }
}
```

今回は処理をするというよりも、いつ実行されるかを評価しますのでコンソールにログを出力することのみ記載しています。これを app.routes.ts に設定します。

```
import { ModuleWithProviders } from '@angular/core';
import { Routes, RouterModule } from '@angular/router';

import { HomeComponent } from './home/home.component';
import { PageNotFoundComponent } from './page-not-found/page-not-found.component';

import { GuardsHomeService } from './home/guards-home.service';

const appRoutes: Routes = [
  { path: '', redirectTo: 'home', pathMatch: 'full'},
  {
    path: 'home',
    component: HomeComponent,
    canActivate: [GuardsHomeService],
    canActivateChild: [GuardsHomeService],
    canDeactivate: [GuardsHomeService],
    resolve: [GuardsHomeService],
    canLoad: [GuardsHomeService],
  },
  { path: '**', component: PageNotFoundComponent }
];

export const appRoutingProviders: any[] = [];

export const routing: ModuleWithProviders = RouterModule.forRoot(appRoutes);
```

次に app.module.ts にプロバイダ登録します。

```
import { BrowserModule } from '@angular/platform-browser';
import { NgModule } from '@angular/core';
import { FormsModule } from '@angular/forms';
import { HttpModule } from '@angular/http';

import { PagesModule} from './pages/pages.module'

import { AppComponent } from './app.component';
import { HomeComponent } from './home/home.component';
import { PageNotFoundComponent } from './page-not-found/page-not-found.component';
import { FooterComponent } from './footer/footer.component';

import { routing, appRoutingProviders } from './app.routes';

import { GuardsHomeService } from './home/guards-home.service';

@NgModule({
  declarations: [
    AppComponent,
    HomeComponent,
    PageNotFoundComponent,
    FooterComponent
  ],
  imports: [
    BrowserModule,
    FormsModule,
    HttpModule,
    PagesModule,
    routing
  ],
  providers: [
    appRoutingProviders,
    GuardsHomeService
  ],
  bootstrap: [AppComponent]
})
export class AppModule { }
```

### PagesにGaurdsを定義

guards-pages.service.ts は次のように定義しています。

```
import { Injectable } from '@angular/core';;
import {
  CanActivate,
  CanActivateChild,
  CanDeactivate,
  Resolve,
  CanLoad
} from '@angular/router';

import { PagesComponent } from './pages.component';

@Injectable()
export class GuardsPagesService implements CanActivate, CanActivateChild, CanDeactivate<PagesComponent>, Resolve<PagesComponent>, CanLoad {

  constructor() { }

  canActivate(): boolean {
    console.log('GuardsPagesService.canActivate()');
    return true;
  }

  canActivateChild(): boolean {
    console.log('GuardsPagesService.canActivateChild()');
    return true;
  }

  canDeactivate(): boolean {
    console.log('GuardsPagesService.canDeactivate()');
    return true;
  }

  resolve(): boolean {
    console.log('GuardsPagesService.resolve()');
    return true;
  }

  canLoad(): boolean {
    console.log('GuardsPagesService.canLoad()');
    return true;
  }
}
```

guards-top.service.ts は次のように定義しています。

```
import { Injectable } from '@angular/core';;
import {
  CanActivate,
  CanActivateChild,
  CanDeactivate,
  Resolve,
  CanLoad
} from '@angular/router';

import { TopComponent } from './top.component';

@Injectable()
export class GuardsTopService implements CanActivate, CanActivateChild, CanDeactivate<TopComponent>, Resolve<TopComponent>, CanLoad {

  constructor() { }

  canActivate(): boolean {
    console.log('GuardsTopService.canActivate()');
    return true;
  }

  canActivateChild(): boolean {
    console.log('GuardsTopService.canActivateChild()');
    return true;
  }

  canDeactivate(): boolean {
    console.log('GuardsTopService.canDeactivate()');
    return true;
  }

  resolve(): boolean {
    console.log('GuardsTopService.resolve()');
    return true;
  }

  canLoad(): boolean {
    console.log('GuardsTopService.canLoad()');
    return true;
  }
}
```

guards-wiki.service.ts は次のように定義しています。

```
import { Injectable } from '@angular/core';;
import {
  CanActivate,
  CanActivateChild,
  CanDeactivate,
  Resolve,
  CanLoad
} from '@angular/router';

import { WikiComponent } from './wiki.component';

@Injectable()
export class GuardsWikiService implements CanActivate, CanActivateChild, CanDeactivate<WikiComponent>, Resolve<WikiComponent>, CanLoad {

  constructor() { }

  canActivate(): boolean {
    console.log('GuardsWikiService.canActivate()');
    return true;
  }

  canActivateChild(): boolean {
    console.log('GuardsWikiService.canActivateChild()');
    return true;
  }

  canDeactivate(): boolean {
    console.log('GuardsWikiService.canDeactivate()');
    return true;
  }

  resolve(): boolean {
    console.log('GuardsWikiService.resolve()');
    return true;
  }

  canLoad(): boolean {
    console.log('GuardsWikiService.canLoad()');
    return true;
  }
}
```

guards-issue.service.ts は次のように定義しています。

```
import { Injectable } from '@angular/core';;
import {
  CanActivate,
  CanActivateChild,
  CanDeactivate,
  Resolve,
  CanLoad
} from '@angular/router';

import { IssueComponent } from './issue.component';

@Injectable()
export class GuardsIssueService implements CanActivate, CanActivateChild, CanDeactivate<IssueComponent>, Resolve<IssueComponent>, CanLoad {

  constructor() { }

  canActivate(): boolean {
    console.log('GuardsIssueService.canActivate()');
    return true;
  }

  canActivateChild(): boolean {
    console.log('GuardsIssueService.canActivateChild()');
    return true;
  }

  canDeactivate(): boolean {
    console.log('GuardsIssueService.canDeactivate()');
    return true;
  }

  resolve(): boolean {
    console.log('GuardsIssueService.resolve()');
    return true;
  }

  canLoad(): boolean {
    console.log('GuardsIssueService.canLoad()');
    return true;
  }
}
```

pages.routes.ts はそれぞれの Guards を定義します

```
import { ModuleWithProviders } from '@angular/core';
import { Routes, RouterModule } from '@angular/router';

import { PagesComponent } from './pages.component';
import { IssueComponent } from './issue/issue.component';
import { TopComponent } from './top/top.component';
import { WikiComponent } from './wiki/wiki.component';

import { GuardsPagesService } from './guards-pages.service';
import { GuardsIssueService } from './issue/guards-issue.service';
import { GuardsTopService } from './top/guards-top.service';
import { GuardsWikiService } from './wiki/guards-wiki.service';

const pagesRoutes: Routes = [
  {
    path: 'pages',
    component: PagesComponent,
    canActivate: [GuardsPagesService],
    canActivateChild: [GuardsPagesService],
    canDeactivate: [GuardsPagesService],
    resolve: [GuardsPagesService],
    canLoad: [GuardsPagesService],
    children: [
      { path: '', redirectTo: 'top', pathMatch: 'full' },
      {
        path: 'top',
        component: TopComponent,
        canActivate: [GuardsTopService],
        canActivateChild: [GuardsTopService],
        canDeactivate: [GuardsTopService],
        resolve: [GuardsTopService],
        canLoad: [GuardsTopService]
      },
      {
        path: 'issue',
        component: IssueComponent,
        canActivate: [GuardsIssueService],
        canActivateChild: [GuardsIssueService],
        canDeactivate: [GuardsIssueService],
        resolve: [GuardsIssueService],
        canLoad: [GuardsIssueService]
      },
      {
        path: 'wiki',
        component: WikiComponent,
        canActivate: [GuardsWikiService],
        canActivateChild: [GuardsWikiService],
        canDeactivate: [GuardsWikiService],
        resolve: [GuardsWikiService],
        canLoad: [GuardsWikiService]
      }
    ]
  }
];

export const pagesRoutingProviders: any[] = [];

export const pagesRouting: ModuleWithProviders = RouterModule.forChild(pagesRoutes);
```

そしてプロバイダ登録をすると実行し評価することが可能となります。pages.module.ts は

```
import { NgModule } from '@angular/core';
import { CommonModule } from '@angular/common';

import { IssueModule } from './issue/issue.module';
import { WikiModule } from './wiki/wiki.module';

import { PagesComponent } from './pages.component';
import { TopComponent } from './top/top.component';

import { pagesRouting, pagesRoutingProviders } from './pages.routes';

import { GuardsPagesService } from './guards-pages.service';
import { GuardsTopService } from './top/guards-top.service';
import { GuardsWikiService } from './wiki/guards-wiki.service';
import { GuardsIssueService } from './issue/guards-issue.service';

@NgModule({
  imports: [
    CommonModule,
    IssueModule,
    WikiModule,
    pagesRouting
  ],
  providers: [
    pagesRoutingProviders,
    GuardsPagesService,
    GuardsTopService,
    GuardsWikiService,
    GuardsIssueService
  ],
  declarations: [
    PagesComponent,
    TopComponent
  ]
})
export class PagesModule { }
```

さて、ブラウザを起動しコンソールを開いて下さい。メニューをクリックするとログが表示されます。この後は、もし戻りが false だったらといった具合に各自で評価してください。

# Component Lifecycle Hooks

Component の Lifecycle Hooks については  [angular.io](https://angular.io/docs/ts/latest/guide/lifecycle-hooks.html) に詳しく書いています。実際にもう利用していて

```
  ngOnInit() {
  }
```

はそれにあたります。これ以外には

* ngOnChanges
* ngOnInit
* ngDoCheck
* ngAfterContentInit
* ngAfterContentChacked
* ngAfterViewInit
* ngAfterViewChacked
* ngOnDestroy

があります。 constructor も含め処理タイミングを確認すると良いでしょう。


> 注意事項として constructor に多くの処理を記述しないのがベターです。基本的に初期処理は ngOnInit に記載すべきです。



