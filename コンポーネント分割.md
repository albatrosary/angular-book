コンポーネント分割することで様々なメリットが現れます。テストが行いやすいというのもそのひとつです。機能的には今までと同じものですが、今回は更新画面も合わせて作ってみます。早速作業しましょう。

```
$ ng g component pages/issue/issue-detail
$ ng g component pages/issue/issue-input
$ ng g component pages/issue/issue-list
$ ng g component pages/issue/issue-update
```

### issue.component

はじめに`issue.component`を修正します。issue.componentはIssueの入力コンポーネントと入力された一覧を表示する部分を表示させるために定義します。

`issue.component.html` は次のようになります。

```
<h2>Issue</h2>
<app-issue-input></app-issue-input>
<app-issue-list></app-issue-list>
```

`issue.component.ts` は特別に処理というものが無いので次のような何も無くなります。

```
import { Component, OnInit } from '@angular/core';
import { NgForm } from '@angular/forms';

@Component({
  selector: 'app-issue',
  templateUrl: './issue.component.html',
  styleUrls: ['./issue.component.css']
})
export class IssueComponent implements OnInit {

  constructor (
  ) {}

  ngOnInit() {
  }
}
```

### issue-detail.component

`issue-detail.component.html`は一覧の詳細部分のみを記載します。

```
<div>{{rownum+1}}</div>
<p>{{title}}</p>
<pre>{{desc}}</pre>
<button (click)="onClick($event)">削除</button>
<button (click)="gotoUpdate()">更新</button>
```

`issue-detail.component.ts`では、@Inputによりissue-list.componentからデータを取得し、@OutputとEmitterを利用しイベントをissue-list.componentへ渡しています。

```
import { Component, OnInit, Input, Output, EventEmitter } from'@angular/core';
import { Router } from '@angular/router';

@Component({
  selector: 'app-issue-detail',
  templateUrl: './issue-detail.component.html',
  styleUrls: ['./issue-detail.component.css']
})
export class IssueDetailComponent implements OnInit {

  @Input('rownum')
  rownum: number;

  @Input('title')
  title: string;

  @Input('desc')
  desc: string;

  @Output()
  private onDelete = new EventEmitter();
  public onClick($event: any): void {
    this.onDelete.emit($event);
  }

  public gotoUpdate(): void {
    this.router.navigate(['/pages/issue/update', this.rownum]);
  }

  constructor(
    private router: Router
  ) { }

  ngOnInit() {
  }

}
```

### issue-input.component

issue-input.component.htmlでは入力部のみを定義しています。

```
<form #f="ngForm" (ngSubmit)="onSubmit(f)"novalidate>
  <input name="title" ngModel required placeholder="title">
  <textarea name="desc" ngModel required placeholder="desc"></textarea>
  <button type=submit [disabled]="!f.form.valid">登録</button>
</form>
```

issue-input.component.ts では入力された値をIssueServiceへ登録する部分のみ定義しています。

```
import { Component, OnInit } from'@angular/core';
import { NgForm } from'@angular/forms';

import { IssueService } from'../issue.service';

@Component({
  selector: 'app-issue-input',
  templateUrl: './issue-input.component.html',
  styleUrls: ['./issue-input.component.css']
})
export class IssueInputComponent implements OnInit {

  constructor(
    private issueService: IssueService
  ) {
  }

  ngOnInit() {
  }

  public onSubmit(form: NgForm): void {

    const issue = {
      title: form.value.title,
      desc: form.value.desc
    };

    this.issueService.add(issue);

    form.reset();
  }

}
```

### issue-list.component

issue-list.component.htmlではIssue登録された情報を一覧化し詳細についてはIssueDetailへ渡しています。

```
<div *ngFor="let issue of issues; let i = index">
  <app-issue-detail
    [rownum]="i"
    [title]="issue.title"
    [desc]="issue.desc"
    (onDelete)="onDelete(i)">
  </app-issue-detail>
</div>
```

issue-list.component.ts ではIssueServiceからデータを取得し、データを削除する部分を記載しています。

```
import { Component, OnInit } from'@angular/core';

import { Issue } from'../issue';
import { IssueService } from'../issue.service';

@Component({
  selector: 'app-issue-list',
  templateUrl: './issue-list.component.html',
  styleUrls: ['./issue-list.component.css']
})
export class IssueListComponent implements OnInit {

  issues: Issue[];

  constructor (
    private issueService: IssueService
  ) {}

  public ngOnInit () {
    this.issues = this.issueService.list;
  }

  public onDelete(index: number): void {
    this.issueService.delete(index);
  }

}
```

### issue-update.component

今回はこれに加え更新する画面も作成します。`issue-update.component.html`は

```
<form #f="ngForm" (ngSubmit)="onSubmit(f)" novalidate>
  <input class="id" name="id" [(ngModel)]="id" required placeholder="id">
  <input name="title" [(ngModel)]="title" required placeholder="title">
  <textarea name="desc" [(ngModel)]="desc" required placeholder="desc"></textarea>
  <button type=submit [disabled]="!f.form.valid">更新</button>
</form>
```

`issue-update.component.ts`は

```
import { Component, OnInit } from '@angular/core';
import { NgForm } from '@angular/forms';
import { Router, ActivatedRoute, Params } from '@angular/router';

import 'rxjs/add/operator/switchMap';

import { IssueService } from '../issue.service';
import { Issue } from '../issue';

@Component({
  selector: 'app-issue-update',
  templateUrl: './issue-update.component.html',
  styleUrls: ['./issue-update.component.css']
})
export class IssueUpdateComponent implements OnInit {

  id: number;

  title: string;

  desc: string;

  constructor(
    private router: Router,
    private route: ActivatedRoute,
    private issueService: IssueService
  ) {
  }

  ngOnInit() {
    this.route.params
      .switchMap((params: Params) => {
        this.id = +params['id'];
        return this.issueService.getIssue(this.id);
      })
      .subscribe(issue => {
        this.title = issue.title;
        this.desc = issue.desc;
      });
  }

  public onSubmit(form: NgForm): void {

    const issue = {
      title: form.value.title,
      desc: form.value.desc
    };

    this.issueService.update(form.value.id, issue);

    this.gotoIssue();
  }

  private gotoIssue() {
    this.router.navigate(['./pages/issue']);
  }

}
```

## issue.module

issue.module.ts も確認します。

```
import { NgModule } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';

import { IssueComponent } from './issue.component';
import { IssueDetailComponent } from './issue-detail/issue-detail.component';
import { IssueInputComponent } from './issue-input/issue-input.component';
import { IssueListComponent } from './issue-list/issue-list.component';
import { IssueUpdateComponent } from './issue-update/issue-update.component';

import { IssueService } from './issue.service';

@NgModule({
  imports: [
    CommonModule,
    FormsModule
  ],
  declarations: [
    IssueComponent,
    IssueDetailComponent,
    IssueInputComponent,
    IssueListComponent,
    IssueUpdateComponent
  ],
  providers: [IssueService]
})
export class IssueModule { }
```

## pages.routes

pages.routes.ts に更新用の設定を追加します。尚、ルーティングで更新画面は表示されますが、実装はまだしていません。次のHTTPで実装していきます。

```
import { ModuleWithProviders } from '@angular/core';
import { Routes, RouterModule } from '@angular/router';

import { PagesComponent } from './pages.component';
import { IssueComponent } from './issue/issue.component';
import { IssueUpdateComponent } from './issue/issue-update/issue-update.component';
import { TopComponent } from './top/top.component';
import { WikiComponent } from './wiki/wiki.component';

import { GuardsPagesService } from './guards-pages.service';
import { GuardsIssueService } from './issue/guards-issue.service';
import { GuardsTopService } from './top/guards-top.service';
import { GuardsWikiService } from './wiki/guards-wiki.service';

const pagesRoutes: Routes = [
  {
    path: 'pages',
    component: PagesComponent,
    canActivate: [GuardsPagesService],
    canActivateChild: [GuardsPagesService],
    canDeactivate: [GuardsPagesService],
    resolve: [GuardsPagesService],
    canLoad: [GuardsPagesService],
    children: [
      { path: '', redirectTo: 'top', pathMatch: 'full' },
      {
        path: 'top',
        component: TopComponent,
        canActivate: [GuardsTopService],
        canActivateChild: [GuardsTopService],
        canDeactivate: [GuardsTopService],
        resolve: [GuardsTopService],
        canLoad: [GuardsTopService]
      },
      {
        path: 'issue',
        component: IssueComponent,
        canActivate: [GuardsIssueService],
        canActivateChild: [GuardsIssueService],
        canDeactivate: [GuardsIssueService],
        resolve: [GuardsIssueService],
        canLoad: [GuardsIssueService]
      },
      { path: 'issue/update/:id', component: IssueUpdateComponent },
      {
        path: 'wiki',
        component: WikiComponent,
        canActivate: [GuardsWikiService],
        canActivateChild: [GuardsWikiService],
        canDeactivate: [GuardsWikiService],
        resolve: [GuardsWikiService],
        canLoad: [GuardsWikiService]
      }
    ]
  }
];

export const pagesRoutingProviders: any[] = [];

export const pagesRouting: ModuleWithProviders = RouterModule.forChild(pagesRoutes);
```

これでコンポーネント分割が完了しました。それほど手間無くコンポーネント分割できたと思います。

> このコンポーネント分割はどういった単位で行えばいいのかという話があります。明確な回答はありません。比較的エンジニアによるところが大きいのではないかと思います。場合によってはボタンひとつでもコンポーネント化した方が良い場合もあると思います。アジャイルやスクラムで開発したとしても設計を見直し、プロジェクトとしてどのようにコンポーネント化すれば良いのかをチーム内でミーティングするのが好ましいでしょう。

ここまでの src/app ディレクトリの構成を記載します。

```
$ tree
.
├── app.component.css
├── app.component.html
├── app.component.spec.ts
├── app.component.ts
├── app.module.ts
├── app.routes.ts
├── footer
│   ├── footer.component.css
│   ├── footer.component.html
│   ├── footer.component.spec.ts
│   └── footer.component.ts
├── home
│   ├── guards-home.service.spec.ts
│   ├── guards-home.service.ts
│   ├── home.component.css
│   ├── home.component.html
│   ├── home.component.spec.ts
│   └── home.component.ts
├── index.ts
├── page-not-found
│   ├── page-not-found.component.css
│   ├── page-not-found.component.html
│   ├── page-not-found.component.spec.ts
│   └── page-not-found.component.ts
└── pages
    ├── guards-pages.service.spec.ts
    ├── guards-pages.service.ts
    ├── issue
    │   ├── guards-issue.service.spec.ts
    │   ├── guards-issue.service.ts
    │   ├── issue-detail
    │   │   ├── issue-detail.component.css
    │   │   ├── issue-detail.component.html
    │   │   ├── issue-detail.component.spec.ts
    │   │   └── issue-detail.component.ts
    │   ├── issue-input
    │   │   ├── issue-input.component.css
    │   │   ├── issue-input.component.html
    │   │   ├── issue-input.component.spec.ts
    │   │   └── issue-input.component.ts
    │   ├── issue-list
    │   │   ├── issue-list.component.css
    │   │   ├── issue-list.component.html
    │   │   ├── issue-list.component.spec.ts
    │   │   └── issue-list.component.ts
    │   ├── issue-update
    │   │   ├── issue-update.component.css
    │   │   ├── issue-update.component.html
    │   │   ├── issue-update.component.spec.ts
    │   │   └── issue-update.component.ts
    │   ├── issue.component.css
    │   ├── issue.component.html
    │   ├── issue.component.spec.ts
    │   ├── issue.component.ts
    │   ├── issue.module.ts
    │   ├── issue.service.spec.ts
    │   ├── issue.service.ts
    │   └── issue.ts
    ├── pages.component.css
    ├── pages.component.html
    ├── pages.component.spec.ts
    ├── pages.component.ts
    ├── pages.module.ts
    ├── pages.routes.ts
    ├── top
    │   ├── guards-top.service.spec.ts
    │   ├── guards-top.service.ts
    │   ├── top.component.css
    │   ├── top.component.html
    │   ├── top.component.spec.ts
    │   └── top.component.ts
    └── wiki
        ├── guards-wiki.service.spec.ts
        ├── guards-wiki.service.ts
        ├── markdown.pipe.spec.ts
        ├── markdown.pipe.ts
        ├── wiki.component.css
        ├── wiki.component.html
        ├── wiki.component.spec.ts
        ├── wiki.component.ts
        └── wiki.module.ts

11 directories, 70 files
$
```



